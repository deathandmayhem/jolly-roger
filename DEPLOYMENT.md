# Deploying Jolly Roger

## Running a production instance

To run Jolly Roger on a server for lots of people to use, see the [Deployment
and Monitoring](https://guide.meteor.com/deployment.html) documentation for
Meteor. There are many ways to run the server, but they boil down to taking the
tarball generated by `meteor build`, untarring it on some server, setting
environment variables (see below), and running `node main.js`.

Meteor v3 apps (like Jolly Roger) require [Node.js](https://nodejs.org/) v22. If
you're using a container, install that version. If you're running as a regular
process, consider using a version manager like
[nvm](https://github.com/nvm-sh/nvm), [Volta](https://volta.sh/),
[asdf](https://asdf-vm.com/) or (my favorite) [mise](https://mise.jdx.dev/).

You will also need some dependent services, at the very least a Mongo DB
instance (for `$MONGO_URL`), some way to send email (for `$MAIL_URL`), a web
server that can forward to your server and `$PORT`, and some domain name
pointing to that web server (hopefully with an SSL certificate).

As a "canned configuration" for all of that,
[`cloudformation/jolly-roger.yaml`](cloudformation/jolly-roger.yaml) is a
template for [AWS CloudFormation](https://aws.amazon.com/cloudformation/). You
will need to edit it for your use (change the domain name, etc) but then it can
spin up a production system including Jolly Roger, a load balancer, a TURN
server, SSL certificates, autoscaling and so on using Amazon Web Services. This
configuration expects a database hosted elsewhere, like [MongoDB
Atlas](https://www.mongodb.com/atlas/database).

## Server environment variables

You can configure development and production Jolly Roger servers with a number
of environment variables.

- `$CLUSTER_WORKERS_COUNT` - server process count, `"auto"` for the machine's
  core count, 1 by default.

- `$MAIL_URL` ([email](https://docs.meteor.com/api/email)) - an `smtp://` or
  `smtps://` URL for sending email, mostly for user signup. If your server has a
  self-signed TLS certificate, add `?tls.rejectUnauthorized=false` to the URL.

- `$MONGO_URL` ([Meteor
  core](https://docs.meteor.com/environment-variables#MONGO_URL)) - the [MongoDB
  server](https://www.mongodb.com/) to use for storing Hunt and user data. This
  can be a server you run, or a server hosted on something like [MongoDB
  Atlas](https://www.mongodb.com/atlas/database). In development, a mini local
  MongoDB instance is set up for you.

- `$MONGO_OPLOG_URL` ([Meteor
  core](https://docs.meteor.com/environment-variables#MONGO_OPLOG_URL)) - the
  [MongoDB operations log
  server](https://www.mongodb.com/docs/manual/core/replica-set-oplog/) to use
  for change monitoring. Strongly recommended for production, not needed for
  development. Requires the server to be a [replica
  set](https://www.mongodb.com/docs/manual/replication/) (can be size 1).
  Typically this is the `$MONGO_URL` with `/local` replacing the Jolly Roger
  database name.

- `$PORT` ([Meteor core](https://docs.meteor.com/environment-variables#PORT)) -
  the socket port to listen for HTTP connections. Defaults to 3000. For dev, use
  `--port=XXXX` instead.

- `$ROOT_URL` ([Meteor
  core](https://docs.meteor.com/environment-variables#ROOT_URL)) - the base URL
  used to access your server. Not needed for dev servers.

- `$TURN_SERVER` - the URL of a [TURN
  server](https://webrtc.org/getting-started/turn-server) for robust audio chat
  connectivity.

- `$TURN_SECRET` - the secret needed to authenticate with `$TURN_SERVER`.

Also see the other environment variables defined by [Meteor
core](https://docs.meteor.com/environment-variables) and other packages.

## Setting up a fresh server

For initial setup steps (admin account creation, server options, integrations,
and example hunt data), see [Setting up a fresh Jolly Roger
server](DEVELOPMENT.md#setting-up-a-fresh-jolly-roger-server) in DEVELOPMENT.md.
